---
title: "Project 9-16"
author: "Cal Parker"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown


# Check if "last_date.txt" file exists
if (file.exists("last_date.txt")) {
  # Read the last date from the file
  last_date <- as.Date(readLines("last_date.txt"))
} else {
  # If no previous date, start with today's date
  last_date <- Sys.Date()
}

# Print the last date
cat("Last date was:", last_date, "\n")

# Increment the date using lubridate (by 1 day, 1 week, or 1 month)
new_date <- last_date + days(1)    # Increment by 1 day
# new_date <- last_date + weeks(1) # Increment by 1 week
# new_date <- last_date + months(1) # Increment by 1 month
# new_date <- last_date + years(1) # Increment by 1 year

# Print the new date
cat("New date is:", new_date, "\n")

# Save the new date to the file for future runs
writeLines(as.character(new_date), "last_date.txt")

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}

# Load necessary libraries

#install.packages('httr')
#install.packages('jsonlite')
#install.packages("bizdays")
library(httr)
library(jsonlite)
library(bizdays)
library(lubridate)             

counter = 0
# Replace 'demo' with your actual API key

#install.packages("lubridate")  # Install the package (if not installed yet)
# Load the package

# Assign a specific past date (Year-Month-Day format)

library(lubridate)

if (file.exists("past_date.txt")) {
  # Read the past date from the file
  past_date <- as.Date(readLines("past_date.txt"))
} else {
  # If no file exists, initialize with a specific past date
  past_date <- ymd("2024-08-27")
}

past_date <- past_date + 1
print(past_date)

# Print the updated past_date
#cat("The new past date is:", past_date, "\n")

# Save the updated past_date to the file for the next run
writeLines(as.character(past_date), "past_date.txt")

# Define a string and an integer

api_key <- 'your_api_key'
function1 <- 'HISTORICAL_OPTIONS'
date <- past_date
symbol <- 'NIO'
dataType <- 'csv'

for(date_range in date)
  
{
# Build the URL for the API request
url <- paste0('https://www.alphavantage.co/query?function=', function1,
              '&symbol=', symbol, 
              '&date=', date,
              '&apikey=', api_key)

# Make the GET request
response <- GET(url)
}
  


if (status_code(response) == 200) {
  
  # Parse the JSONcontent
  data <- content(response, as = "text", encoding = "UTF-8")
  
  # Convert JSON data into an R object
  parsed_data <- fromJSON(data, flatten = TRUE)
  
  parsed_data
  # Convert list to data frame
  my_data_frame <- as.data.frame(parsed_data)
  
  #my_data_frame

  
  if (file.exists("NIO Options Data.csv")) {
  # Read the past date from the file
   # Retain column names but remove all rows
  blank_data_frame <- my_data_frame
  #existing_data_frame
    
  
# Check if the data frame has no columns and create a new data frame if so
  
  
  
  

if (nrow(my_data_frame) == 0) {
  
  existing_data_zero_rows<-data.frame()
  
  new_data_first <- my_data_frame
  
  print(my_data_frame)
  
  combined_data_initial <- rbind(existing_data_zero_rows, new_data_first)
  
  existing_data2 <- combined_data_initial
  
  #existing_data2
  
  # Step 4: Append the new data to an existing CSV file
  csv_file <- 'NIO Options Data.csv'
  
  # If the file already exists, append the new data
  if (file.exists(csv_file)) {
    write.table(existing_data2, file = csv_file, sep = ",", col.names = FALSE, row.names = FALSE, append = TRUE)
  } else {
    # If the file doesn't exist, create a new one
    write.csv(existing_data2, file = csv_file, row.names = FALSE)
  }
  

} else {
  
  existing_data4<-data.frame()
  
  new_data_append <- my_data_frame
  # Step 3: Append the new data to the existing dataset using rbind
  combined_data <- rbind(existing_data4, new_data_append)

  # View the combined data
  print(combined_data)

  # Update the existing data
  existing_data2 <- combined_data
  print(existing_data2)
  
  
  # Step 4: Append the new data to an existing CSV file
  csv_file <- 'NIO Options Data.csv'
  
  
  # If the file already exists, append the new data
  if (file.exists(csv_file)) {
    write.table(existing_data2, file = csv_file, sep = ",", col.names = FALSE, row.names = FALSE, append = TRUE)
  } else {
    # If the file doesn't exist, create a new one
    write.csv(existing_data2, file = csv_file, row.names = FALSE)
  }


# Step 2: Create new data to append
  #appending_new_data <- my_data_frame

  #existing_data<-combined_data

  #combined_data <<- rbind(existing_data, appending_new_data)

# View the combined data
print(combined_data)

existing_data<-combined_data

print(existing_data)


}
  

} 
  
  
  else 
  {
  Print("No File")
  }
  
} else {
  cat("Error: Unable to fetch data. Status code:", status_code(response), "\n")
}



```

